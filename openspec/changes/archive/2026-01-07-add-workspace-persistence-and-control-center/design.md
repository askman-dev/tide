# Design: Workspace Persistence and Control Center

## Context
Tide ç›®å‰ä¸ä¿å­˜ä»»ä½•è¿è¡Œæ—¶çŠ¶æ€ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½æ˜¯å…¨æ–°çŠ¶æ€ã€‚ç”¨æˆ·éœ€è¦ï¼š
1. é‡å¯åæ¢å¤ä¹‹å‰æ‰“å¼€çš„ workspace
2. å¿«é€Ÿæ‰§è¡Œå¸¸ç”¨çš„ AI CLI å·¥å…·ï¼ˆclaude, gemini, codex ç­‰ï¼‰
3. åœ¨ terminal åŒºåŸŸæœ‰é›†ä¸­çš„æ§åˆ¶å…¥å£

## Goals
- å®ç° workspace çŠ¶æ€æŒä¹…åŒ–ï¼ˆè·¯å¾„ + ç„¦ç‚¹ tabï¼‰
- æä¾› Control Center ä½œä¸º terminal åŒºåŸŸçš„æ§åˆ¶å…¥å£
- æ”¯æŒå¯é…ç½®çš„ Launcher å¿«é€Ÿå‘½ä»¤
- æ¯ä¸ª split pane æ˜¾ç¤ºå½“å‰è¿è¡Œçš„å‘½ä»¤åç§°

## Non-Goals
- ä¸ä¿å­˜ split pane å¸ƒå±€ï¼ˆé‡å¯ååªå¯åŠ¨é»˜è®¤å• paneï¼‰
- ä¸ä¿å­˜çª—å£ä½ç½®/å¤§å°
- ä¸ä¿å­˜å·¦ä¾§é¢æ¿å±•å¼€çŠ¶æ€
- Launcher ä¸æ”¯æŒ per-workspace é…ç½®ï¼ˆåªæœ‰å…¨å±€é…ç½®ï¼‰

## Decisions

### 1. çŠ¶æ€å­˜å‚¨ä½ç½®
- **Decision**: ä½¿ç”¨ `~/.config/tide/` ç›®å½•
- **Files**:
  - `state.json` - è¿è¡Œæ—¶çŠ¶æ€ï¼ˆworkspace åˆ—è¡¨ã€ç„¦ç‚¹ tabï¼‰
  - `launchers.json` - Launcher é…ç½®
- **Rationale**: éµå¾ª XDG è§„èŒƒï¼Œå¼€å‘è€…å·¥å…·å¸¸ç”¨æ­¤è·¯å¾„
- **Note**: æ˜ç¡®ä¸ä½¿ç”¨ macOS çš„ `~/Library/Application Support/`ï¼Œä¿æŒè·¨å¹³å°ä¸€è‡´æ€§
- **Simplification**: æœ¬é˜¶æ®µç¡¬ç¼–ç è·¯å¾„ï¼Œä¸æŠ½è±¡è·¨å¹³å°é…ç½®ç›®å½•ç­–ç•¥ï¼Œæœªæ¥å¦‚éœ€æ”¯æŒå†é‡æ„

### 2. çŠ¶æ€æ–‡ä»¶æ ¼å¼

**state.json**:
```json
{
  "version": 1,
  "workspaces": [
    "/Users/admin/projects/tide",
    "/Users/admin/projects/other"
  ],
  "active_workspace_index": 0
}
```

**launchers.json**:
```json
{
  "version": 1,
  "launchers": [
    {
      "name": "Claude",
      "command": "claude -c",
      "run_in": "current"
    },
    {
      "name": "GLM",
      "command": "ANTHROPIC_API_KEY= ANTHROPIC_AUTH_TOKEN=xxx ANTHROPIC_BASE_URL=https://open.bigmodel.cn/api/anthropic ~/.local/bin/claude --model glm-4.6",
      "run_in": "new_split"
    },
    {
      "name": "Gemini",
      "command": "gemini",
      "run_in": "current"
    }
  ]
}
```

### 3. Control Center UI å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Control Center    [Claude] [Gemini] [Codex]                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ claude   [ğŸ“‹Path][ğŸ“‹Out][Ã—]â”‚ â”‚ â”‚ gemini  [ğŸ“‹Path][ğŸ“‹Out][Ã—]â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚                           â”‚ â”‚ â”‚                         â”‚ â”‚
â”‚ â”‚    Terminal Content       â”‚ â”‚ â”‚   Terminal Content      â”‚ â”‚
â”‚ â”‚                           â”‚ â”‚ â”‚                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Control Center Header ç»„ä»¶**ï¼ˆå…¨å±€ï¼‰:
- Launcher æŒ‰é’®åˆ—è¡¨ï¼ˆå¯é…ç½®ï¼Œç‚¹å‡»ç›´æ¥æ‰§è¡Œå‘½ä»¤ï¼‰
- æœ¬é˜¶æ®µä¸ºæ™®é€šæŒ‰é’®ï¼Œä¸å«ä¸‹æ‹‰èœå•æˆ–æ–°å¢æŒ‰é’®

**Pane Title Bar ç»„ä»¶**ï¼ˆæ¯ä¸ª pane ç‹¬ç«‹ï¼‰:
- å·¦ä¾§ï¼šå‘½ä»¤åç§°ï¼ˆå¦‚ "claude"ã€"gemini"ï¼‰
- å³ä¾§æ“ä½œæŒ‰é’®ï¼š
  - [å¤åˆ¶å¯¹è¯è·¯å¾„] - å¤åˆ¶è¯¥ pane çš„ claude å¯¹è¯æ–‡ä»¶è·¯å¾„
  - [å¤åˆ¶æœ€åè¾“å‡º] - å¤åˆ¶è¯¥ pane æœ€åä¸€è½®è¾“å‡º
  - [Ã—] å…³é—­ paneï¼ˆå¯é€‰ï¼‰

### 4. Launcher æ‰§è¡Œé€»è¾‘

- **current**: åœ¨å½“å‰ç„¦ç‚¹ pane æ‰§è¡Œå‘½ä»¤ï¼ˆå†™å…¥ PTYï¼‰
- **new_split**: å‘å³åˆ†å‰²åˆ›å»ºæ–° paneï¼Œç„¶åæ‰§è¡Œå‘½ä»¤ï¼ˆå›ºå®šä¸º Split Rightï¼‰

### 5. Pane Title è·å–æ–¹å¼

**æ–¹æ¡ˆ**: é€šè¿‡ OSC Title äº‹ä»¶è·å–æ ‡é¢˜ï¼ˆæœ€å¯é ï¼‰

åˆ©ç”¨ alacritty_terminal å·²æœ‰çš„ `Event::Title` æœºåˆ¶ï¼š
- Shell é€šè¿‡ OSC escape sequence å‘é€æ ‡é¢˜ï¼ˆå¦‚ `\e]0;title\a`ï¼‰
- alacritty_terminal è§£æåè§¦å‘ `Event::Title(title)` äº‹ä»¶
- `TideEventListener.on_title_change` å›è°ƒæ¥æ”¶æ ‡é¢˜
- æ›´æ–°å¯¹åº” pane çš„ `title: RwSignal<String>`

**ä¸ºä»€ä¹ˆé€‰æ‹© OSC Title è€Œé Grid è§£æ**:
- Grid è§£æéœ€è¦è¯†åˆ«å„ç§ prompt æ ¼å¼ï¼ˆ`$`ã€`>`ã€`#`ã€`â†’`ã€`âœ`ã€`â¯` ç­‰ï¼‰ï¼Œæ— æ³•ç©·ä¸¾
- oh-my-zsh/fish/powerlevel10k ç­‰ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ï¼Œè§£æå›°éš¾
- OSC Title æ˜¯ shell ä¸»åŠ¨å‘ŠçŸ¥ï¼Œæœ€å‡†ç¡®ï¼ˆiTerm2 ä¹Ÿç”¨æ­¤æ–¹æ¡ˆï¼‰
- ç°æœ‰ä»£ç å·²æœ‰ `Event::Title` å¤„ç†æ¡†æ¶

**å®ç°è¦ç‚¹**:
1. `TerminalSession::new()` æ¥æ”¶ `on_title_change: Arc<dyn Fn(String) + Send + Sync>` å›è°ƒ
2. `TideEventListener` åœ¨ `Event::Title` æ—¶è°ƒç”¨å›è°ƒ
3. å›è°ƒä¸­æ›´æ–° pane.title ä¿¡å·
4. éœ€è¦å°† pane.title ä¿¡å·ä¼ é€’åˆ° session åˆ›å»ºå¤„

**ä¾èµ–æ¡ä»¶**:
- ç”¨æˆ·çš„ shell éœ€é…ç½®å‘é€ OSC æ ‡é¢˜ï¼ˆå¤§å¤šæ•°ç°ä»£ shell é»˜è®¤æ”¯æŒï¼‰
- æœªé…ç½®æ—¶ä¿æŒé»˜è®¤æ ‡é¢˜ "Terminal"

### 6. çŠ¶æ€ä¿å­˜æ—¶æœº

- **ä¿å­˜**: 
  - Tab åˆ‡æ¢æ—¶
  - æ–°å¢/å…³é—­ workspace æ—¶
  - åº”ç”¨é€€å‡ºæ—¶ï¼ˆWindowClose äº‹ä»¶ï¼‰
- **åŠ è½½**: åº”ç”¨å¯åŠ¨æ—¶

## Risks / Trade-offs

| Risk | Mitigation |
|------|------------|
| çŠ¶æ€æ–‡ä»¶æŸåå¯¼è‡´å¯åŠ¨å¤±è´¥ | åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤çŠ¶æ€ï¼Œä¸ crashï¼Œå†™ ERROR log |
| çŠ¶æ€ä¿å­˜å¤±è´¥ï¼ˆæƒé™/ç£ç›˜æ»¡ï¼‰ | å†™ ERROR logï¼Œç»§ç»­è¿è¡Œï¼Œä¸ crash |
| Launcher å‘½ä»¤åŒ…å«æ•æ„Ÿä¿¡æ¯ | æ—¥å¿—åªè®°å½• launcher nameï¼Œä¸è®°å½•å®Œæ•´ command |
| PTY å‘½ä»¤è§£æä¸å‡†ç¡® | ä¿å®ˆè§£æï¼Œæ‰¾ prompt åˆ†éš”ç¬¦åå–ç¬¬ä¸€ä¸ªç©ºæ ¼å‰çš„ token |

## Migration Plan
- é¦–æ¬¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»º `~/.config/tide/` ç›®å½•
- é…ç½®æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä½¿ç”¨é»˜è®¤å€¼
- ç‰ˆæœ¬å­—æ®µæ”¯æŒæœªæ¥æ ¼å¼å‡çº§

## Open Questions
1. é­”æ³•åŠŸèƒ½ï¼ˆå¤åˆ¶å¯¹è¯è·¯å¾„ã€å¤åˆ¶è¾“å‡ºï¼‰çš„å…·ä½“å®ç°å¾…å®šï¼Œå…ˆæ”¾ç½®å ä½æŒ‰é’®
2. Launcher é…ç½®æ˜¯å¦éœ€è¦ UI ç¼–è¾‘ç•Œé¢ï¼Ÿï¼ˆå»ºè®®å…ˆåªæ”¯æŒæ‰‹åŠ¨ç¼–è¾‘ JSONï¼‰
